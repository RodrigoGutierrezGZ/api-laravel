name: "CI/CD Pipeline Demo - Simplified"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PHP_VERSION: "8.2"
  NODE_VERSION: "18"

jobs:
  # ===========================================
  # JOB 1: TESTING & QUALITY ASSURANCE
  # ===========================================
  test-and-quality:
    name: "üß™ Tests & Quality"
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: laravel_testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üêò Setup PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: xdebug

      - name: "üì¶ Cache Composer"
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - name: "üîß Install Dependencies"
        run: composer install --prefer-dist --no-interaction --optimize-autoloader

      - name: "üìã Create Testing Environment"
        run: |
          cp .env.example .env.testing
          php artisan key:generate --env=testing

      - name: "üß™ Run PHPUnit Tests"
        run: php artisan test --coverage

      - name: "üîç PHPStan Analysis"
        run: ./vendor/bin/phpstan analyse --memory-limit=2G

      - name: "üíÖ Laravel Pint (PSR-12)"
        run: ./vendor/bin/pint --test

  # ===========================================
  # JOB 2: DOCKER BUILD & PUSH
  # ===========================================
  docker-build:
    name: "üê≥ Docker Build"
    needs: test-and-quality
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üê≥ Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "üîê Login to GitHub Registry"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "üèóÔ∏è Build and Push Image"
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ===========================================
  # JOB 3: DEMO DEPLOYMENT (DOCKER COMPOSE)
  # ===========================================
  demo-deployment:
    name: "üöÄ Demo Deployment"
    needs: [test-and-quality, docker-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üîß Setup Environment"
        run: |
          cp .env.example .env
          sed -i 's/DB_HOST=127.0.0.1/DB_HOST=mysql/' .env
          sed -i 's/DB_DATABASE=laravel/DB_DATABASE=laravel_demo/' .env
          sed -i 's/DB_USERNAME=root/DB_USERNAME=root/' .env
          sed -i 's/DB_PASSWORD=/DB_PASSWORD=secret/' .env

      - name: "üê≥ Start Demo Environment"
        run: |
          docker-compose up -d --build
          sleep 30

      - name: "üè• Health Check"
        run: |
          echo "Waiting for application to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/health 2>/dev/null; then
              echo "‚úÖ Application is healthy!"
              break
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 10
          done

      - name: "üß™ API Endpoint Tests"
        run: |
          echo "Testing GET /api/products"
          curl -X GET http://localhost:8000/api/products -H "Accept: application/json" | jq .
          
          echo "Testing POST /api/products"
          curl -X POST http://localhost:8000/api/products \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{"name":"Test Product","description":"Test Description","price":99.99}' | jq .

      - name: "üßπ Cleanup"
        if: always()
        run: docker-compose down -v

  # ===========================================
  # JOB 4: SECURITY SCAN (SIMPLIFIED)
  # ===========================================
  security-scan:
    name: "üîí Security Scan"
    needs: test-and-quality
    runs-on: ubuntu-latest
    
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4

      - name: "üêò Setup PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: "üì¶ Install Dependencies"
        run: composer install --no-dev --optimize-autoloader

      - name: "üîç Security Audit"
        run: |
          composer audit
          echo "‚úÖ Security scan completed"

# ===========================================
# DEPLOYMENT NOTES FOR PRODUCTION:
# ===========================================
# 
# Para un entorno de producci√≥n real, necesitar√≠as configurar:
# 
# 1. GitHub Secrets:
#    - CODECOV_TOKEN (opcional - para coverage reports)
#    - SLACK_WEBHOOK (opcional - para notificaciones)
#    - SSH keys para servidores (STAGING_SSH_KEY, PRODUCTION_SSH_KEY)
#    - DEPLOY_TOKEN (Personal Access Token para clonar repos)
#    - URLs de entornos (STAGING_URL, PRODUCTION_URL)
#    - ANSIBLE_VAULT_PASSWORD (para secrets encriptados)
#
# 2. Infraestructura:
#    - Servidores de staging y producci√≥n configurados
#    - Ansible instalado y configurado
#    - Docker y Docker Compose en servidores target
#
# 3. DNS y SSL:
#    - Dominios configurados apuntando a los servidores
#    - Certificados SSL (Let's Encrypt recomendado)
#
# Esta versi√≥n simplificada es perfecta para demostraci√≥n y desarrollo.